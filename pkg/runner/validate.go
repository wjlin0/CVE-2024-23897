package runner

import (
	"fmt"
	"github.com/wjlin0/CVE-2024-23897/pkg/types"
	"time"
)

const (
	DefaultThread           = 30
	DefaultTimeout          = 10
	DefaultInputReadTimeout = 3 * time.Minute
)

func ValidateRunEnumeration(options *types.Options) error {

	// loading the proxy server list from file or cli and test the connectivity
	if err := loadProxyServers(options); err != nil {
		return err
	}

	if options.Exec && options.ListAvailableCommands {
		return fmt.Errorf("cannot use -exec and -list-available-commands at the same time")
	}
	// set default input
	if options.Thread <= 0 {
		options.Thread = DefaultThread
	}
	if options.Timeout <= 0 {
		options.Timeout = DefaultTimeout
	}
	if options.InputReadTimeout <= 0 {
		options.InputReadTimeout = DefaultInputReadTimeout
	}
	for _, f := range options.Args {
		if len(f) >= 65535 {
			return fmt.Errorf("filename length must be less than 65535")
		}
	}

	if !options.IsListAvailableCommands() && !options.IsExecMode() && len(options.Args) != 0 && len(options.Command) == 0 {
		options.Command = append(options.Command, "who-am-i")
	}
	if !options.IsListAvailableCommands() && !options.IsExecMode() && len(options.Args) == 0 && len(options.Command) != 0 {
		options.Args = append(options.Args, "/etc/passwd")
	}

	return nil
}
