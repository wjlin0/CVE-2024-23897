package runner

import (
	"fmt"
	"github.com/fatih/color"
	"github.com/projectdiscovery/gologger"
	"github.com/projectdiscovery/gologger/formatter"
	"github.com/projectdiscovery/gologger/levels"
	"github.com/wjlin0/CVE-2024-23897/pkg/output"
	"github.com/wjlin0/CVE-2024-23897/pkg/types"
	"strings"
)

func SetOutput(options *types.Options) {
	if options.Debug {
		gologger.DefaultLogger.SetMaxLevel(levels.LevelDebug)
	}
	if options.NoColor {
		color.NoColor = true
		gologger.DefaultLogger.SetFormatter(formatter.NewCLI(options.NoColor))
	}
}

func (r *Runner) AddSuccess() {
	r.Lock()
	defer r.Unlock()
	r.success++
}

func (r *Runner) Output(event *output.ResultEvent) {
	r.Lock()
	defer r.Unlock()
	opts := r.options
	if event.URL == "" {
		return
	}
	buffer := strings.Builder{}
	buffer.WriteRune('[')
	buffer.WriteString(color.HiRedString("CVE-2024-23897"))
	buffer.WriteRune(']')
	buffer.WriteRune(' ')
	buffer.WriteString(event.URL)
	buffer.WriteRune('\n')
	if event.Mode != 0 {
		buffer.WriteString(fmt.Sprintf("Mode: %s\n", event.Mode))
	}
	if event.Command != "" && event.Mode != output.ModeCheck {
		buffer.WriteString(fmt.Sprintf("Command: %s\n", event.Command))
	}
	if event.Mode == output.ModeReadFile && event.Args != "" {
		buffer.WriteString(fmt.Sprintf("Filename: %s\n", strings.TrimLeft(event.Args, "@")))
	} else if event.Args != "" {
		buffer.WriteString(fmt.Sprintf("Args: %s\n", event.Args))
	}

	if event.Response != "" {
		buffer.WriteString(strings.TrimSuffix(event.Response, "\n"))
		buffer.WriteRune('\n')
	}
	if opts.Debug && event.Error != "" {
		buffer.WriteString(color.YellowString(event.Error))
		buffer.WriteRune('\n')
	}

	fmt.Println(buffer.String())
}
