package scanner

import (
	"encoding/hex"
	"fmt"
	"github.com/wjlin0/CVE-2024-23897/pkg/output"
	"strings"
	"testing"
)

func TestExtractAvailableCommands(t *testing.T) {
	helpFullText := "00 00 00 00 12 08 20 20 61 64 64 2D 6A 6F 62 2D 74 6F 2D 76 69 65 77 0A 00 00 00 17 08 20 20 20 20 41 64 64 73 20 6A 6F 62 73 20 74 6F 20 76 69 65 77 2E 0A 00 00 00 08 08 20 20 62 75 69 6C 64 0A 00 00 00 3D 08 20 20 20 20 42 75 69 6C 64 73 20 61 20 6A 6F 62 2C 20 61 6E 64 20 6F 70 74 69 6F 6E 61 6C 6C 79 20 77 61 69 74 73 20 75 6E 74 69 6C 20 69 74 73 20 63 6F 6D 70 6C 65 74 69 6F 6E 2E 0A 00 00 00 14 08 20 20 63 61 6E 63 65 6C 2D 71 75 69 65 74 2D 64 6F 77 6E 0A 00 00 00 33 08 20 20 20 20 43 61 6E 63 65 6C 20 74 68 65 20 65 66 66 65 63 74 20 6F 66 20 74 68 65 20 22 71 75 69 65 74 2D 64 6F 77 6E 22 20 63 6F 6D 6D 61 6E 64 2E 0A 00 00 00 0E 08 20 20 63 6C 65 61 72 2D 71 75 65 75 65 0A 00 00 00 1C 08 20 20 20 20 43 6C 65 61 72 73 20 74 68 65 20 62 75 69 6C 64 20 71 75 65 75 65 2E 0A 00 00 00 0F 08 20 20 63 6F 6E 6E 65 63 74 2D 6E 6F 64 65 0A 00 00 00 1B 08 20 20 20 20 52 65 63 6F 6E 6E 65 63 74 20 74 6F 20 61 20 6E 6F 64 65 28 73 29 0A 00 00 00 0A 08 20 20 63 6F 6E 73 6F 6C 65 0A 00 00 00 29 08 20 20 20 20 52 65 74 72 69 65 76 65 73 20 63 6F 6E 73 6F 6C 65 20 6F 75 74 70 75 74 20 6F 66 20 61 20 62 75 69 6C 64 2E 0A 00 00 00 0B 08 20 20 63 6F 70 79 2D 6A 6F 62 0A 00 00 00 12 08 20 20 20 20 43 6F 70 69 65 73 20 61 20 6A 6F 62 2E 0A 00 00 00 0D 08 20 20 63 72 65 61 74 65 2D 6A 6F 62 0A 00 00 00 44 08 20 20 20 20 43 72 65 61 74 65 73 20 61 20 6E 65 77 20 6A 6F 62 20 62 79 20 72 65 61 64 69 6E 67 20 73 74 64 69 6E 20 61 73 20 61 20 63 6F 6E 66 69 67 75 72 61 74 69 6F 6E 20 58 4D 4C 20 66 69 6C 65 2E 0A 00 00 00 0E 08 20 20 63 72 65 61 74 65 2D 6E 6F 64 65 0A 00 00 00 40 08 20 20 20 20 43 72 65 61 74 65 73 20 61 20 6E 65 77 20 6E 6F 64 65 20 62 79 20 72 65 61 64 69 6E 67 20 73 74 64 69 6E 20 61 73 20 61 20 58 4D 4C 20 63 6F 6E 66 69 67 75 72 61 74 69 6F 6E 2E 0A 00 00 00 0E 08 20 20 63 72 65 61 74 65 2D 76 69 65 77 0A 00 00 00 40 08 20 20 20 20 43 72 65 61 74 65 73 20 61 20 6E 65 77 20 76 69 65 77 20 62 79 20 72 65 61 64 69 6E 67 20 73 74 64 69 6E 20 61 73 20 61 20 58 4D 4C 20 63 6F 6E 66 69 67 75 72 61 74 69 6F 6E 2E 0A 00 00 00 10 08 20 20 64 65 6C 65 74 65 2D 62 75 69 6C 64 73 0A 00 00 00 1D 08 20 20 20 20 44 65 6C 65 74 65 73 20 62 75 69 6C 64 20 72 65 63 6F 72 64 28 73 29 2E 0A 00 00 00 0D 08 20 20 64 65 6C 65 74 65 2D 6A 6F 62 0A 00 00 00 14 08 20 20 20 20 44 65 6C 65 74 65 73 20 6A 6F 62 28 73 29 2E 0A 00 00 00 0E 08 20 20 64 65 6C 65 74 65 2D 6E 6F 64 65 0A 00 00 00 14 08 20 20 20 20 44 65 6C 65 74 65 73 20 6E 6F 64 65 28 73 29 0A 00 00 00 0E 08 20 20 64 65 6C 65 74 65 2D 76 69 65 77 0A 00 00 00 15 08 20 20 20 20 44 65 6C 65 74 65 73 20 76 69 65 77 28 73 29 2E 0A 00 00 00 0E 08 20 20 64 69 73 61 62 6C 65 2D 6A 6F 62 0A 00 00 00 14 08 20 20 20 20 44 69 73 61 62 6C 65 73 20 61 20 6A 6F 62 2E 0A 00 00 00 11 08 20 20 64 69 73 61 62 6C 65 2D 70 6C 75 67 69 6E 0A 00 00 00 2B 08 20 20 20 20 44 69 73 61 62 6C 65 20 6F 6E 65 20 6F 72 20 6D 6F 72 65 20 69 6E 73 74 61 6C 6C 65 64 20 70 6C 75 67 69 6E 73 2E 0A 00 00 00 12 08 20 20 64 69 73 63 6F 6E 6E 65 63 74 2D 6E 6F 64 65 0A 00 00 00 1D 08 20 20 20 20 44 69 73 63 6F 6E 6E 65 63 74 73 20 66 72 6F 6D 20 61 20 6E 6F 64 65 2E 0A 00 00 00 0D 08 20 20 65 6E 61 62 6C 65 2D 6A 6F 62 0A 00 00 00 13 08 20 20 20 20 45 6E 61 62 6C 65 73 20 61 20 6A 6F 62 2E 0A 00 00 00 10 08 20 20 65 6E 61 62 6C 65 2D 70 6C 75 67 69 6E 0A 00 00 00 38 08 20 20 20 20 45 6E 61 62 6C 65 73 20 6F 6E 65 20 6F 72 20 6D 6F 72 65 20 69 6E 73 74 61 6C 6C 65 64 20 70 6C 75 67 69 6E 73 20 74 72 61 6E 73 69 74 69 76 65 6C 79 2E 0A 00 00 00 0A 08 20 20 67 65 74 2D 6A 6F 62 0A 00 00 00 2C 08 20 20 20 20 44 75 6D 70 73 20 74 68 65 20 6A 6F 62 20 64 65 66 69 6E 69 74 69 6F 6E 20 58 4D 4C 20 74 6F 20 73 74 64 6F 75 74 2E 0A 00 00 00 0B 08 20 20 67 65 74 2D 6E 6F 64 65 0A 00 00 00 2D 08 20 20 20 20 44 75 6D 70 73 20 74 68 65 20 6E 6F 64 65 20 64 65 66 69 6E 69 74 69 6F 6E 20 58 4D 4C 20 74 6F 20 73 74 64 6F 75 74 2E 0A 00 00 00 0B 08 20 20 67 65 74 2D 76 69 65 77 0A 00 00 00 2D 08 20 20 20 20 44 75 6D 70 73 20 74 68 65 20 76 69 65 77 20 64 65 66 69 6E 69 74 69 6F 6E 20 58 4D 4C 20 74 6F 20 73 74 64 6F 75 74 2E 0A 00 00 00 09 08 20 20 67 72 6F 6F 76 79 0A 00 00 00 2B 08 20 20 20 20 45 78 65 63 75 74 65 73 20 74 68 65 20 73 70 65 63 69 66 69 65 64 20 47 72 6F 6F 76 79 20 73 63 72 69 70 74 2E 20 0A 00 00 00 0B 08 20 20 67 72 6F 6F 76 79 73 68 0A 00 00 00 26 08 20 20 20 20 52 75 6E 73 20 61 6E 20 69 6E 74 65 72 61 63 74 69 76 65 20 67 72 6F 6F 76 79 20 73 68 65 6C 6C 2E 0A 00 00 00 07 08 20 20 68 65 6C 70 0A 00 00 00 52 08 20 20 20 20 4C 69 73 74 73 20 61 6C 6C 20 74 68 65 20 61 76 61 69 6C 61 62 6C 65 20 63 6F 6D 6D 61 6E 64 73 20 6F 72 20 61 20 64 65 74 61 69 6C 65 64 20 64 65 73 63 72 69 70 74 69 6F 6E 20 6F 66 20 73 69 6E 67 6C 65 20 63 6F 6D 6D 61 6E 64 2E 0A 00 00 00 11 08 20 20 69 6E 73 74 61 6C 6C 2D 70 6C 75 67 69 6E 0A 00 00 00 4A 08 20 20 20 20 49 6E 73 74 61 6C 6C 73 20 61 20 70 6C 75 67 69 6E 20 65 69 74 68 65 72 20 66 72 6F 6D 20 61 20 66 69 6C 65 2C 20 61 6E 20 55 52 4C 2C 20 6F 72 20 66 72 6F 6D 20 75 70 64 61 74 65 20 63 65 6E 74 65 72 2E 20 0A 00 00 00 0D 08 20 20 6B 65 65 70 2D 62 75 69 6C 64 0A 00 00 00 2E 08 20 20 20 20 4D 61 72 6B 20 74 68 65 20 62 75 69 6C 64 20 74 6F 20 6B 65 65 70 20 74 68 65 20 62 75 69 6C 64 20 66 6F 72 65 76 65 72 2E 0A 00 00 00 0F 08 20 20 6C 69 73 74 2D 63 68 61 6E 67 65 73 0A 00 00 00 34 08 20 20 20 20 44 75 6D 70 73 20 74 68 65 20 63 68 61 6E 67 65 6C 6F 67 20 66 6F 72 20 74 68 65 20 73 70 65 63 69 66 69 65 64 20 62 75 69 6C 64 28 73 29 2E 0A 00 00 00 0C 08 20 20 6C 69 73 74 2D 6A 6F 62 73 0A 00 00 00 35 08 20 20 20 20 4C 69 73 74 73 20 61 6C 6C 20 6A 6F 62 73 20 69 6E 20 61 20 73 70 65 63 69 66 69 63 20 76 69 65 77 20 6F 72 20 69 74 65 6D 20 67 72 6F 75 70 2E 0A 00 00 00 0F 08 20 20 6C 69 73 74 2D 70 6C 75 67 69 6E 73 0A 00 00 00 29 08 20 20 20 20 4F 75 74 70 75 74 73 20 61 20 6C 69 73 74 20 6F 66 20 69 6E 73 74 61 6C 6C 65 64 20 70 6C 75 67 69 6E 73 2E 0A 00 00 00 0F 08 20 20 6F 66 66 6C 69 6E 65 2D 6E 6F 64 65 0A 00 00 00 5F 08 20 20 20 20 53 74 6F 70 20 75 73 69 6E 67 20 61 20 6E 6F 64 65 20 66 6F 72 20 70 65 72 66 6F 72 6D 69 6E 67 20 62 75 69 6C 64 73 20 74 65 6D 70 6F 72 61 72 69 6C 79 2C 20 75 6E 74 69 6C 20 74 68 65 20 6E 65 78 74 20 22 6F 6E 6C 69 6E 65 2D 6E 6F 64 65 22 20 63 6F 6D 6D 61 6E 64 2E 0A 00 00 00 0E 08 20 20 6F 6E 6C 69 6E 65 2D 6E 6F 64 65 0A 00 00 00 61 08 20 20 20 20 52 65 73 75 6D 65 20 75 73 69 6E 67 20 61 20 6E 6F 64 65 20 66 6F 72 20 70 65 72 66 6F 72 6D 69 6E 67 20 62 75 69 6C 64 73 2C 20 74 6F 20 63 61 6E 63 65 6C 20 6F 75 74 20 74 68 65 20 65 61 72 6C 69 65 72 20 22 6F 66 66 6C 69 6E 65 2D 6E 6F 64 65 22 20 63 6F 6D 6D 61 6E 64 2E 0A 00 00 00 0D 08 20 20 71 75 69 65 74 2D 64 6F 77 6E 0A 00 00 00 4F 08 20 20 20 20 51 75 69 65 74 20 64 6F 77 6E 20 4A 65 6E 6B 69 6E 73 2C 20 69 6E 20 70 72 65 70 61 72 61 74 69 6F 6E 20 66 6F 72 20 61 20 72 65 73 74 61 72 74 2E 20 44 6F 6E A1 AF 74 20 73 74 61 72 74 20 61 6E 79 20 62 75 69 6C 64 73 2E 0A 00 00 00 17 08 20 20 72 65 6C 6F 61 64 2D 63 6F 6E 66 69 67 75 72 61 74 69 6F 6E 0A 00 00 00 8A 08 20 20 20 20 44 69 73 63 61 72 64 20 61 6C 6C 20 74 68 65 20 6C 6F 61 64 65 64 20 64 61 74 61 20 69 6E 20 6D 65 6D 6F 72 79 20 61 6E 64 20 72 65 6C 6F 61 64 20 65 76 65 72 79 74 68 69 6E 67 20 66 72 6F 6D 20 66 69 6C 65 20 73 79 73 74 65 6D 2E 20 55 73 65 66 75 6C 20 77 68 65 6E 20 79 6F 75 20 6D 6F 64 69 66 69 65 64 20 63 6F 6E 66 69 67 20 66 69 6C 65 73 20 64 69 72 65 63 74 6C 79 20 6F 6E 20 64 69 73 6B 2E 0A 00 00 00 0D 08 20 20 72 65 6C 6F 61 64 2D 6A 6F 62 0A 00 00 00 12 08 20 20 20 20 52 65 6C 6F 61 64 20 6A 6F 62 28 73 29 0A 00 00 00 17 08 20 20 72 65 6D 6F 76 65 2D 6A 6F 62 2D 66 72 6F 6D 2D 76 69 65 77 0A 00 00 00 1C 08 20 20 20 20 52 65 6D 6F 76 65 73 20 6A 6F 62 73 20 66 72 6F 6D 20 76 69 65 77 2E 0A 00 00 00 0A 08 20 20 72 65 73 74 61 72 74 0A 00 00 00 15 08 20 20 20 20 52 65 73 74 61 72 74 20 4A 65 6E 6B 69 6E 73 2E 0A 00 00 00 0F 08 20 20 73 61 66 65 2D 72 65 73 74 61 72 74 0A 00 00 00 33 08 20 20 20 20 53 61 66 65 20 52 65 73 74 61 72 74 20 4A 65 6E 6B 69 6E 73 2E 20 44 6F 6E A1 AF 74 20 73 74 61 72 74 20 61 6E 79 20 62 75 69 6C 64 73 2E 0A 00 00 00 10 08 20 20 73 61 66 65 2D 73 68 75 74 64 6F 77 6E 0A 00 00 00 6C 08 20 20 20 20 50 75 74 73 20 4A 65 6E 6B 69 6E 73 20 69 6E 74 6F 20 74 68 65 20 71 75 69 65 74 20 6D 6F 64 65 2C 20 77 61 69 74 20 66 6F 72 20 65 78 69 73 74 69 6E 67 20 62 75 69 6C 64 73 20 74 6F 20 62 65 20 63 6F 6D 70 6C 65 74 65 64 2C 20 61 6E 64 20 74 68 65 6E 20 73 68 75 74 20 64 6F 77 6E 20 4A 65 6E 6B 69 6E 73 2E 0A 00 00 00 0D 08 20 20 73 65 73 73 69 6F 6E 2D 69 64 0A 00 00 00 47 08 20 20 20 20 4F 75 74 70 75 74 73 20 74 68 65 20 73 65 73 73 69 6F 6E 20 49 44 2C 20 77 68 69 63 68 20 63 68 61 6E 67 65 73 20 65 76 65 72 79 20 74 69 6D 65 20 4A 65 6E 6B 69 6E 73 20 72 65 73 74 61 72 74 73 2E 0A 00 00 00 18 08 20 20 73 65 74 2D 62 75 69 6C 64 2D 64 65 73 63 72 69 70 74 69 6F 6E 0A 00 00 00 25 08 20 20 20 20 53 65 74 73 20 74 68 65 20 64 65 73 63 72 69 70 74 69 6F 6E 20 6F 66 20 61 20 62 75 69 6C 64 2E 0A 00 00 00 19 08 20 20 73 65 74 2D 62 75 69 6C 64 2D 64 69 73 70 6C 61 79 2D 6E 61 6D 65 0A 00 00 00 25 08 20 20 20 20 53 65 74 73 20 74 68 65 20 64 69 73 70 6C 61 79 4E 61 6D 65 20 6F 66 20 61 20 62 75 69 6C 64 2E 0A 00 00 00 0B 08 20 20 73 68 75 74 64 6F 77 6E 0A 00 00 00 2B 08 20 20 20 20 49 6D 6D 65 64 69 61 74 65 6C 79 20 73 68 75 74 73 20 64 6F 77 6E 20 4A 65 6E 6B 69 6E 73 20 73 65 72 76 65 72 2E 0A 00 00 00 0E 08 20 20 73 74 6F 70 2D 62 75 69 6C 64 73 0A 00 00 00 27 08 20 20 20 20 53 74 6F 70 20 61 6C 6C 20 72 75 6E 6E 69 6E 67 20 62 75 69 6C 64 73 20 66 6F 72 20 6A 6F 62 28 73 29 0A 00 00 00 0D 08 20 20 75 70 64 61 74 65 2D 6A 6F 62 0A 00 00 00 54 08 20 20 20 20 55 70 64 61 74 65 73 20 74 68 65 20 6A 6F 62 20 64 65 66 69 6E 69 74 69 6F 6E 20 58 4D 4C 20 66 72 6F 6D 20 73 74 64 69 6E 2E 20 54 68 65 20 6F 70 70 6F 73 69 74 65 20 6F 66 20 74 68 65 20 67 65 74 2D 6A 6F 62 20 63 6F 6D 6D 61 6E 64 2E 0A 00 00 00 0E 08 20 20 75 70 64 61 74 65 2D 6E 6F 64 65 0A 00 00 00 56 08 20 20 20 20 55 70 64 61 74 65 73 20 74 68 65 20 6E 6F 64 65 20 64 65 66 69 6E 69 74 69 6F 6E 20 58 4D 4C 20 66 72 6F 6D 20 73 74 64 69 6E 2E 20 54 68 65 20 6F 70 70 6F 73 69 74 65 20 6F 66 20 74 68 65 20 67 65 74 2D 6E 6F 64 65 20 63 6F 6D 6D 61 6E 64 2E 0A 00 00 00 0E 08 20 20 75 70 64 61 74 65 2D 76 69 65 77 0A 00 00 00 56 08 20 20 20 20 55 70 64 61 74 65 73 20 74 68 65 20 76 69 65 77 20 64 65 66 69 6E 69 74 69 6F 6E 20 58 4D 4C 20 66 72 6F 6D 20 73 74 64 69 6E 2E 20 54 68 65 20 6F 70 70 6F 73 69 74 65 20 6F 66 20 74 68 65 20 67 65 74 2D 76 69 65 77 20 63 6F 6D 6D 61 6E 64 2E 0A 00 00 00 0A 08 20 20 76 65 72 73 69 6F 6E 0A 00 00 00 21 08 20 20 20 20 4F 75 74 70 75 74 73 20 74 68 65 20 63 75 72 72 65 6E 74 20 76 65 72 73 69 6F 6E 2E 0A 00 00 00 14 08 20 20 77 61 69 74 2D 6E 6F 64 65 2D 6F 66 66 6C 69 6E 65 0A 00 00 00 27 08 20 20 20 20 57 61 69 74 20 66 6F 72 20 61 20 6E 6F 64 65 20 74 6F 20 62 65 63 6F 6D 65 20 6F 66 66 6C 69 6E 65 2E 0A 00 00 00 13 08 20 20 77 61 69 74 2D 6E 6F 64 65 2D 6F 6E 6C 69 6E 65 0A 00 00 00 26 08 20 20 20 20 57 61 69 74 20 66 6F 72 20 61 20 6E 6F 64 65 20 74 6F 20 62 65 63 6F 6D 65 20 6F 6E 6C 69 6E 65 2E 0A 00 00 00 0B 08 20 20 77 68 6F 2D 61 6D 2D 69 0A 00 00 00 2D 08 20 20 20 20 52 65 70 6F 72 74 73 20 79 6F 75 72 20 63 72 65 64 65 6E 74 69 61 6C 20 61 6E 64 20 70 65 72 6D 69 73 73 69 6F 6E 73 2E 0A 00 00 00 04 04 00 00 00 00"
	// 转换16进制
	helpFullText = strings.ReplaceAll(helpFullText, " ", "") // 移除空格
	bytes, err := hex.DecodeString(helpFullText)
	if err != nil {
		t.Error(err)
		return
	}

	data, err := parseResponseData(output.ModeExec, "help", bytes[1:len(bytes)-1])
	if err != nil {
		t.Error(err)
		return
	}
	commands := extractAvailableCommands(string(data))
	if len(commands) == 0 {
		t.Error("extractAvailableCommands error")
		return
	}
	fmt.Println(commands)
}
